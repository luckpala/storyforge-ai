# StoryForge AI 工具调用机制说明

## 📋 当前机制（标准 Function Calling）

### 1. **API层面的工具调用（正确方式）**

```
用户输入 → AI模型API → 返回结构化响应
                        ├─ text: "回复文本"
                        └─ functionCalls: [{name: "update_chapter_content", args: {...}}]
```

**工作流程：**
1. 应用向AI API发送请求，同时传递**工具定义**（tools参数）
2. AI模型理解用户意图后，**在API响应中**返回结构化的工具调用信息
3. 应用从API响应中提取 `functionCalls` 数组
4. 应用执行这些工具调用，更新故事板
5. 工具执行结果可以发送回AI（可选）

**关键点：**
- ✅ AI模型**在API层面**决定是否调用工具
- ✅ 工具调用信息是**结构化的**，不是文本
- ✅ 应用直接读取 `result.functionCalls`，不需要解析文本

### 2. **代码实现位置**

**`services/llmAdapter.ts` (第86-103行):**
```typescript
const result = await chat.sendMessage({ message: newMessage });
return {
  text: result.text || "",
  functionCalls: normalizeFunctionCalls(result.functionCalls as any), // ← 从API响应中提取
  reasoning
};
```

**`App.tsx` (第1008行):**
```typescript
let functionCalls = result.functionCalls; // ← 直接使用API返回的工具调用
```

## ❌ 当前问题：AI在文本中写JSON

### 问题现象

某些AI模型（或配置）**不会真正调用Function Calling API**，而是在文本回复中写了JSON格式的工具调用：

```
AI回复:
{
  "text": "我将执行以下操作：\n```json\n[{\"tool_name\": \"update_chapter_content\", ...}]\n```",
  "functionCalls": undefined  // ← API没有返回工具调用！
}
```

### 为什么会出现这个问题？

1. **模型不支持Function Calling**：某些模型或API配置不支持工具调用
2. **模型被误导**：系统提示词可能让模型以为"写JSON"就是调用工具
3. **API兼容性问题**：某些反代服务可能没有正确传递工具定义

## 🔧 当前解决方案（文本解析）

### 实现位置：`App.tsx` (第1046-1155行)

**工作流程：**
1. 检查API是否返回了真正的工具调用
2. 如果没有，尝试从文本中解析JSON格式的工具调用
3. 将解析出的工具调用转换为标准格式
4. 执行这些工具调用

**问题：**
- ⚠️ 文本解析不够可靠（JSON可能不完整、格式变化）
- ⚠️ 需要猜测工具名称（如 `update_title_synop` → `update_title_synopsis`）
- ⚠️ 如果AI写错了JSON格式，无法解析

## 💡 改进方案分析

### 方案1：使用第二个AI分析（您的建议）

**优点：**
- ✅ 可以理解自然语言描述的工具调用
- ✅ 可以处理各种格式的文本
- ✅ 更智能，可以纠正错误

**缺点：**
- ❌ 增加API调用成本（每次需要2次API调用）
- ❌ 增加延迟（需要等待第二个AI响应）
- ❌ 增加复杂性（需要管理两个AI的交互）

### 方案2：改进系统提示词（推荐）

**思路：**
- 明确告诉AI：**必须使用Function Calling API，不要写JSON文本**
- 在提示词中强调：文本中的JSON不会被执行
- 如果AI写JSON，自动拒绝并要求重新生成

**优点：**
- ✅ 成本低（不需要额外API调用）
- ✅ 延迟低（不需要等待第二个AI）
- ✅ 从根本上解决问题

**实现：**
```typescript
const BASE_SYSTEM_INSTRUCTION = `
...
**⚠️ 绝对禁止在文本中写JSON格式的工具调用！**
- ❌ 不要写: {"tool_name": "update_chapter_content", ...}
- ✅ 必须使用: 真正的Function Calling API
- 如果API不支持Function Calling，请明确告知用户
...
`;
```

### 方案3：混合方案（最佳）

**思路：**
1. **优先使用标准Function Calling**（如果API支持）
2. **如果API不支持，检测并拒绝文本中的JSON**，提示用户更换模型
3. **作为后备方案，保留文本解析**（但标记为"不可靠"）

**优点：**
- ✅ 优先使用最可靠的方式
- ✅ 明确告知用户问题
- ✅ 保留后备方案

## 🎯 推荐行动

1. **立即改进系统提示词**，明确禁止在文本中写JSON
2. **检测API是否支持Function Calling**，如果不支持，提示用户
3. **保留文本解析作为后备**，但标记为"实验性功能"

## 📊 对比表

| 方案 | 可靠性 | 成本 | 延迟 | 复杂度 |
|------|--------|------|------|--------|
| 标准Function Calling | ⭐⭐⭐⭐⭐ | 低 | 低 | 低 |
| 文本解析（当前） | ⭐⭐ | 低 | 低 | 中 |
| 第二个AI分析 | ⭐⭐⭐⭐ | 高 | 高 | 高 |
| 改进提示词 | ⭐⭐⭐⭐ | 低 | 低 | 低 |
| 混合方案 | ⭐⭐⭐⭐⭐ | 低 | 低 | 中 |

